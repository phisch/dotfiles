#!/usr/bin/env bash

sudo -v
while true; do sleep 60; sudo -n true; kill -0 "$$" || exit; done 2>/dev/null &

setup_directory=$(dirname "$0")

localectl set-keymap de-latin1-nodeadkeys
localectl set-locale en_US.UTF-8
timedatectl set-timezone Europe/Berlin

sudo sed -i '/^#Color$/s/^#//g' /etc/pacman.conf
sudo sed -i '/^#ParallelDownloads =/s/^#//g' /etc/pacman.conf

sudo pacman -Syu --needed --noconfirm - < "$setup_directory/packages/arch_official"

cd $(mktemp -d) && git clone https://aur.archlinux.org/paru-bin.git . && makepkg -sim --noconfirm
paru -Sy --nosudoloop --needed --noconfirm - < "$setup_directory/packages/arch_aur"

sudo systemctl enable --now bluetooth docker fstrim.timer pcscd systemd-timesyncd

gpg --import "$setup_directory/gpg/public-keys.asc"
gpg --import-ownertrust < "$setup_directory/gpg/ownertrust"
gpg-connect-agent "scd serialno" "learn --force" /bye

sudo find ~/.gnupg -type d -exec chmod 700 {} \;
sudo find ~/.gnupg -type f -exec chmod 600 {} \;

pamu2fcfg > ~/.config/Yubico/u2f_keys
for pam_file in "sudo" "polkit-1" "login"; do
    sudo sed -i '2 i auth sufficient pam_u2f.so cue [cue_prompt=Touch the YubiKey to use sudo]' "/etc/pam.d/$pam_file"
done

xdg-user-dirs-update && mkdir -p ~/Pictures/screenshots ~/Videos/recordings

for extension in $(cat "$setup_directory/packages/vscode"); do
    code --install-extension "$extension"
done